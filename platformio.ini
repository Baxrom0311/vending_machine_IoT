; PlatformIO Project Configuration File
;
; eWater Vending Machine - Dual ESP32 Architecture
;
; ESP32 #1 (Payment): Cash acceptor only, UART sender
; ESP32 #2 (Main): Display, relay, sensors, WiFi/MQTT, UART receiver
;

[platformio]
default_envs = esp32_main
src_dir = .

; ============================================
; COMMON SETTINGS
; ============================================
[env]
monitor_speed = 115200
upload_protocol = esptool

; ============================================
; ESP32 #1 - PAYMENT CONTROLLER
; ============================================
; Cash acceptor bilan ishlaydi, UART orqali Main ga yuboradi
; Upload: USB ni Payment ESP32 ga ulang va "pio run -e esp32_payment -t upload"
;
[env:esp32_payment]
platform = espressif32
board = esp32dev
framework = arduino
build_src_filter =
    +<src_esp32_payment/**>
    +<shared/**>
    -<src/**>
    -<src_esp32_main/**>
    -<test/**>
build_flags =
    -D ESP32_PAYMENT
    -D FIRMWARE_VERSION=\"2.4.0-payment\"
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections

; ============================================
; ESP32 #2 - MAIN CONTROLLER
; ============================================
; Display, relay, sensors, WiFi/MQTT bilan ishlaydi
; Upload: USB ni Main ESP32 ga ulang va "pio run -e esp32_main -t upload"
;
[env:esp32_main]
platform = espressif32
board = esp32dev
framework = arduino
lib_deps = 
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^7.2.1
build_src_filter =
    +<src_esp32_main/**>
    +<shared/**>
    -<src/**>
    -<src_esp32_payment/**>
    -<test/**>
build_flags =
    -D ESP32_MAIN
    -D FIRMWARE_VERSION=\"2.4.0-main\"
    ; I2C LCD configuration
    -D LCD_I2C_ADDR=0x3F
    -D LCD_COLS=20
    -D LCD_ROWS=4
    ; Debug control (set to 0 for production)
    -D ENABLE_DEBUG_LOGS=1
    ; Compiler optimizations
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -fno-exceptions

; ============================================
; LEGACY - Original single ESP32 (deprecated)
; ============================================
; Eski kod uchun - src/ papkasini o'zgartirmang
;
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
lib_deps = 
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^7.2.1
build_src_filter =
    +<src/**>
    -<src_esp32_payment/**>
    -<src_esp32_main/**>
    -<shared/**>
build_flags =
    -D LCD_I2C_ADDR=0x27
    -D LCD_COLS=20
    -D LCD_ROWS=4
    -D ENABLE_DEBUG_LOGS=1
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -fno-exceptions

; ============================================
; NATIVE - Unit Tests (host)
; ============================================
[env:native_test]
platform = native
test_framework = unity
test_build_src = false
build_flags =
    -std=gnu++17
    -I test/mocks
    -D ARDUINOJSON_ENABLE_ARDUINO_STRING=1
lib_deps =
    bblanchon/ArduinoJson@^7.4.2

